<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="../css/style-metaball.css" />
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
</head>
<body>
<div class="page page1" style="display: block;">
    <div class="img__metaball-wrap">
        <img src="../img/metaball.png" id="outline">
        <img src="../img/metaball_op.png" id="isoface" style="display: none;">
    </div>
    <div class="formula" id="formula" style="display: none;">
        <div class="formula__item">
            $$(x-x_0)^2 + (y - y_0)^2 = r^2$$
        </div>
        <div class="formula__item">
            $$(x-x_0)^2 + (y - y_0)^2 \leq r^2$$
        </div>
        <div class="formula__item">
            $$\frac{r^2}{(x - x_0)^2 + (y - y_0)^2} \geq 1$$
        </div>
        <div class="formula__item">
            $$f(x, y) = \sum_{i=0}^n \frac{r_i^2}{(x - x_i)^2 + (y - y_i)^2}$$
        </div>
    </div>
    <div class="page__control">
        <a href="#" class="page__control-show">outline</a>
        <a href="#" class="page__control-show">isoface</a>
        <a href="#" class="page__control-show">formula</a>
    </div>
</div>
<div class="page page2">
    <div class="page2__canvas">
        <canvas id="canvas2"></canvas>
    </div>
    <div class="page__control">
        <a href="#" class="page__control-item" id="page2-grid">grid</a>
        <a href="#" class="page__control-item" id="page2-circle">circle</a>
        <a href="#" class="page__control-item" id="page2-highlight">highlight</a>
        <a href="#" class="page__control-item" id="page2-gridDown">gridDown</a>
    </div>
</div>
<div class="page page3">

</div>
<div class="page page3">
    <canvas id="canvas-final"></canvas>
</div>

<div class="control">
    <a href="#" class="control__item current">1</a>
    <a href="#" class="control__item">2</a>
    <a href="#" class="control__item">3</a>
    <a href="#" class="control__item">4</a>
    <a href="#" class="control__item">5</a>
    <a href="#" class="control__item">6</a>
    <a href="#" class="control__item">7</a>
</div>

<script>
    var threshold = 0.8;
    var cubeSize = 50;

    function Circle(width, height) {
        this.width = width;
        this.height = height;
        this.r = 50 + Math.random() * 50;
        this.x = this.r + (Math.random() * (this.width - this.r * 2));
        this.y = this.r + (Math.random() * (this.height - this.r * 2));
        this.vx = -2 + Math.random() * 4;
        this.vy = -2 + Math.random() * 4;
    }
    Circle.prototype.update = function () {
        if (this.x + this.r > this.width || this.x - this.r < 0) {
            this.vx = -this.vx;
        } else if (this.y + this.r > this.height || this.y - this.r < 0) {
            this.vy = -this.vy;
        }
        this.x += this.vx;
        this.y += this.vy;
    };

    Circle.prototype.draw = function (ctx) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.stroke();
    };

    function calmPotential(x, y, circles) {
        var potential = 0;
        for (var i = 0; i < circles.length; i++) {
            var circle = circles[i];
            potential += (circle.r * circle.r) / ((x - circle.x) * (x - circle.x) + (y - circle.y) * (y - circle.y));
        }
        return potential;
    }

    function grid(ctx, width, height) {
        var arr = [];
        for(var i = 0 ; i < width/cubeSize; i++){
            arr[i] = [];
            for( var j = 0; j < height/cubeSize; j++){
                arr[i][j] = {
                    x: i*cubeSize,
                    y: j*cubeSize,
                    active: false
                }
            }
        }
        return arr;
    }

    var page2 = {
        canvas: document.getElementById("canvas2"),
        width: 800,
        height: 600,
        activeGrid : false,
        activeCircle: false,
        activeHighlight: false
    };
    page2.init = function () {
        this.ctx = this.canvas.getContext("2d");
        this.ctx.strokeStyle = "#ffffff";
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        this.grid = grid(this.ctx, this.width, this.height);
        this.circles = [];
        for(var i = 0 ; i < 5; i++){
            this.circles.push(new Circle(this.width, this.height));
        }
        page2.update();
    };
    page2.drawGrid = function () {
        this.ctx.strokeStyle = "rgba(255,255,255,0.2)";
        this.ctx.lineWidth = 4;
        this.ctx.beginPath();
        this.ctx.rect(0, 0, this.width, this.height);
        this.ctx.stroke();
        this.ctx.strokeStyle = "rgba(255,255,255,0.3)";
        this.ctx.lineWidth = 1;
        this.ctx.fillStyle = "rgba(0,0,0,0.5)";

        for(var i = 0 ; i < this.grid.length; i++){
            var row = this.grid[i];
            for( var j = 0; j < row.length; j++){
                this.ctx.beginPath();
                this.ctx.rect(row[j].x, row[j].y, cubeSize, cubeSize);
                this.ctx.stroke();
                if(row[j].active){
                    this.ctx.fill();
                }
            }
        }
    };
    page2.drawCircle = function () {
        for(var i = 0 ; i < this.circles.length; i++){
            this.circles[i].draw(this.ctx);
        }
    };
    page2.drawHighlight = function () {
        for(var i = 0; i < this.grid.length; i++){
            var row = this.grid[i];
            for(var j = 0; j < row.length; j++){
                var cube = row[j];
                cube.active = false;
                var potential = calmPotential(cube.x + cubeSize/2, cube.y + cubeSize/2, page2.circles);
                if(potential >= threshold){
                    cube.active = true;
                }
            }
        }
    };
    page2.update = function () {
        for(var i = 0 ; i < page2.circles.length; i++){
            page2.circles[i].update();
        }
        page2.draw();
        pageAni = requestAnimationFrame(page2.update);
    };

    page2.draw = function () {
        this.ctx.clearRect(0, 0, this.width, this.height);
        if(this.activeGrid){
            this.drawGrid();
        }
        if(this.activeCircle){
            this.ctx.lineWidth = 1;
            this.ctx.strokeStyle = "#ffffff";
            this.drawCircle();
        }
        if(this.activeHighlight){
            this.drawHighlight();
        }

    };

    page2.smallGrid = function () {
        cubeSize = 10;
        page2.init();
    };


</script>
<script>
    var canvas = document.getElementById('canvas-final');
    var context = canvas.getContext('2d');
    var width = canvas.width = window.innerWidth;
    var height = canvas.height = window.innerHeight;
    context.strokeStyle = "#ffffff";
    var cubes = [];
    var circles = [];
    var dots = [];
//    var cubeSize = 10;
    var column = Math.floor(width / cubeSize);
    var row = Math.floor(height / cubeSize);
    var cubeTypes = [];
    var pageAni = null;

    function potentialPos(dotA, dotB, posDir) {
        return dotA[posDir] + (dotB[posDir] - dotA[posDir]) * Math.abs((threshold-dotA.potential)/(dotB.potential - dotA.potential))
    }


    function Cube(lt, rt, lb, rb) {
        this.lt = lt;
        this.rt = rt;
        this.lb = lb;
        this.rb = rb;
        this.typeArr = [];
    }

    Cube.prototype.potentialMap = function (direction) {
        switch (direction){
            case "north":
                return potentialPos(this.lt, this.rt, "x");
                break;
            case "south":
                return potentialPos(this.lb, this.rb, "x");
                break;
            case "west":
                return potentialPos(this.lt, this.lb, "y");
                break;
            case "east":
                return potentialPos(this.rt, this.rb, "y");
        }
    };
    Cube.prototype.update = function () {
        this.typeArr = [];
        if (this.lt.potential > threshold) {
            this.typeArr.push(1);
        } else {
            this.typeArr.push(0);
        }
        if (this.rt.potential > threshold) {
            this.typeArr.push(1);
        } else {
            this.typeArr.push(0);
        }
        if (this.rb.potential > threshold) {
            this.typeArr.push(1);
        } else {
            this.typeArr.push(0);
        }
        if (this.lb.potential > threshold) {
            this.typeArr.push(1);
        } else {
            this.typeArr.push(0);
        }
        this.type = parseInt(this.typeArr.join(''), 2);
    };

    Cube.prototype.draw = function () {
        context.strokeStyle = "#ffffff";
        context.beginPath();
        switch (this.type) {
            case 0:
                break;
            case 1:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 2:
                context.moveTo(this.rt.x, this.potentialMap("east"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 3:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.rt.x, this.potentialMap("east"));
                break;
            case 4:
                context.moveTo(this.potentialMap("north"), this.rt.y);
                context.lineTo(this.rt.x, this.potentialMap("east"));
                break;
            case 5:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("north"), this.rt.y);
                context.moveTo(this.rt.x, this.potentialMap("east"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 6:
                context.moveTo(this.potentialMap("north"), this.rt.y);
                context.lineTo(this.potentialMap("south"), this.rb.y);
                break;
            case 7:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("north"), this.rt.y);
                break;
            case 8:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("north"), this.rt.y);
                break;
            case 9:
                context.moveTo(this.potentialMap("north"), this.rt.y);
                context.lineTo(this.potentialMap("south"), this.rb.y);
                break;
            case 10:
                context.moveTo(this.potentialMap("north"), this.rt.y);
                context.lineTo(this.rt.x, this.potentialMap("east"));
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 11:
                context.moveTo(this.potentialMap("north"), this.rt.y);
                context.lineTo(this.rt.x, this.potentialMap("east"));
                break;
            case 12:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.rt.x, this.potentialMap("east"));
                break;
            case 13:
                context.moveTo(this.rt.x, this.potentialMap("east"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 14:
                context.moveTo(this.lt.x, this.potentialMap("west"));
                context.lineTo(this.potentialMap("south"), this.lb.y);
                break;
            case 15:
                break;
                break;
        }
        context.stroke();
    };

    function Dot(x, y) {
        this.x = x;
        this.y = y;
        this.potential = 0;
    }

    Dot.prototype.set = function (x, y) {
        this.x = x;
        this.y = y;
    };

    Dot.prototype.update = function () {
//        this.potential = calmPotential(this.x, this.y);
    };




    for (var i = 0; i < 10; i++) {
        circles.push(new Circle());
    }

    //点阵,从上到下,从左到右
    for (var i = 0; i < width; i += cubeSize) {
        var arr = [];
        for (var j = 0; j < height; j += cubeSize) {
            var dot = new Dot(i, j);
            dot.update();
            arr.push(dot);
        }
        dots.push(arr);
    }


    for (var i = 0; i < column; i++) {
        for (var j = 0; j < row; j++) {
            try {
                var lt = dots[i][j];
                var rt = dots[i + 1][j];
                var lb = dots[i][j + 1];
                var rb = dots[i + 1][j + 1];
                var cube = new Cube(lt, rt, lb, rb);
                cubes.push(cube);

            } catch (e) {
            }
        }
    }

    //    context.clearRect(0, 0, width, height);
    for (var i = 0; i < circles.length; i++) {
        context.strokeStyle = "#ffffff";
        context.beginPath();
        context.arc(circles[i].x, circles[i].y, circles[i].r, 0, Math.PI * 2);
        context.stroke();
    }

    function loop() {
        context.clearRect(0,0,width,height);
        for (var i = 0; i < circles.length; i++){
            circles[i].update();
            context.strokeStyle = "#ffffff";
//            context.beginPath();
//            context.arc(circles[i].x, circles[i].y, circles[i].r, 0, Math.PI * 2);
//            context.stroke();
        }
        for (var i = 0; i < dots.length; i++) {
            var dotCol = dots[i];
            for (var j = 0; j < dotCol.length; j ++) {
                dotCol[j].update();
            }
        }
        for (var i = 0; i < cubes.length; i++) {
            cubes[i].update();
            cubes[i].draw();
        }
        window.requestAnimationFrame(loop);
    }

//    loop();
</script>
<script>
    $(document).on("click",function (event) {
        var $target = $(event.target);
        if($target.hasClass("page__control-show")){
            var text = $target.text();
            $("#" + text).toggle();
        }else if($target.hasClass("control__item")){
            var index = $target.text() - 1;
            $(".page").hide();
            $(".page").eq(index).show();
            $(".control__item").removeClass("current");
            $(".control__item").eq(index).addClass("current");
            if(index == 1){
                page2.init();
            }else if(index == 2){

            }
        }else if($target.hasClass("page__control-item")){
            var id = $target.attr("id");
            if(id == "page2-grid"){
                if(page2.activeGrid){
                    page2.activeGrid = false;
                }else {
                    page2.activeGrid = true;
                }
            }else if(id == "page2-circle"){
                if(page2.activeCircle){
                    page2.activeCircle = false;
                }else {
                    page2.activeCircle = true;
                }
            }else if(id == "page2-highlight"){
                if(page2.activeHighlight){
                    page2.activeHighlight = false;
                }else {
                    page2.activeHighlight = true;
                }
            }else if(id == "page2-gridDown"){
                page2.smallGrid();
            }
        }
    })
</script>
</body>
</html>
