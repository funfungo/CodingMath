<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spring</title>
    <script src="../js/vector3.js"></script>
    <script src="../js/util.js"></script>
    <script src="../js/dat.gui.js"></script>
    <!--<script src="../js/particle.js"></script>-->
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            color: #ffffff;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #191919;
            /*background: #212020 url(../img/gatherround/bg.png) center top;*/
            text-align: center;
        }

        .box1 {

        }
    </style>
</head>
<body>
<!--<div class="box1">Contecting</div>-->
<!--<div class="box2">&lt;Datal&gt;</div>-->
<!--<div class="box3">To over a half</div>-->
<canvas id="canvas"></canvas>
<script>

    var gui = new dat.GUI();

    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    var width = canvas.width = window.innerWidth;
    var height = canvas.height = window.innerHeight;
    var centerX = width / 2;
    var centerY = height / 2;


    var dotImage = new Image();
    dotImage.src = "http://wximg.qq.com/tmt/coding-math/dist/img/gatherround/dot1.png";
    dotImage.onload = function () {
        loop();
    };


    var sphereRad = 130;
    var fLen = 300;
    var maxParticle = 400;
    var particles = [];
    var veloRate;
    var processTime = 0;
    var flagTime = maxParticle * 3;


    //debug
    var turnSpeed = 0.005;
    var greenDotSmallR = 0.98;
    var greenDotBigR = 3;
    var grayDotR = 1.3;
    var finalGreenPercent = 0.6;
    var greenDotBigPercent = 0.82;


    var Particle = function (add) {
        this.startPos = {
            theta: Math.random() * Math.PI,
            phi: 2 * Math.random() * Math.PI
        };
        var startLen = (1 + Math.random() * 2) * sphereRad;
        var x = startLen * Math.sin(this.startPos.theta) * Math.cos(this.startPos.phi);
        var y = startLen * Math.sin(this.startPos.theta) * Math.sin(this.startPos.phi);
        var z = startLen * Math.cos(this.startPos.theta);
        this.nowPos = new Vector(x, y, z);

        this.veloRate = 1 + Math.random() * 2;
        this.velo = this.nowPos.unit().negative().multiply(this.veloRate);
        this.accVelo = new Vector(0,0,0);
        this.finalVelo = 0;
        this.m = fLen / (fLen - this.nowPos.z);

        this.life = 50 + Math.floor(Math.random() * 500);
        this.age = 0;
        this.turnAngle = 0;
        this.wanderTime = 200;
        this.radius = grayDotR / 2 + (Math.random() * grayDotR) / 2;

        this.proj = {};
        this.hover = false;
        this.hoverVelo = new Vector(0, 0, 0);
        this.hoverTime = 50;

        var randomColor = Math.random();
        if (randomColor < (processTime / flagTime) && randomColor < finalGreenPercent) {
            if (Math.random() > greenDotBigPercent) {
                this.color = "rgba(9,187,7,";
                this.radius = greenDotSmallR;
            } else {
                this.img = dotImage;
                this.radius = greenDotBigR / 2 + (Math.random() * greenDotBigR) / 2;
            }
        } else {
            if (Math.random() > 0.5) {
                this.color = "rgba(64,64,64,";
            } else {
                this.color = "rgba(50,50,50,";
            }
        }
    };

    Particle.prototype.update = function () {
        this.nowPosUnit = this.nowPos.unit();

        if (this.hover === true) {
            this.wanderTime = 200;
            if (this.hoverTime > 0) {
                var x = 0.2 * (Math.random() * 2 - 1);
                var y = 0.2 * (Math.random() * 2 - 1);
                var z = 0.1 * (Math.random() * 2);
                this.accVelo = new Vector(x, y, z);
                this.hoverVelo = this.hoverVelo.add(this.accVelo);
                this.nowPos = this.nowPos.add(this.hoverVelo);
                this.hoverTime--;
                this.age++;
                this.op = util.map(this.nowPos.length(), sphereRad, 2*sphereRad, 1, 0);
            } else {
                this.hoverTime = 50;
                this.hover = false;
            }

        }

        else {
            if (this.wanderTime > 0 && this.nowPos.length() > (sphereRad * 1.2)) {
                this.wanderTime--;
                this.accVelo = new Vector()
                this.velo.x += 0.1 * (Math.random() * 2 - 1);
                this.velo.y += 0.1 * (Math.random() * 2 - 1);
                this.velo.z += 0.1 * (Math.random() * 2 - 1);
                this.nowPos = this.nowPos.add(this.velo);
                this.op = util.map(this.nowPos.length(), sphereRad,  2*sphereRad, 1, 0);
            }

            else if (this.nowPos.length() > sphereRad) {
                if (this.finalPos === 0) {
                    this.finalPos = this.nowPosUnit.multiply(sphereRad);
                }
                if (this.finalVelo === 0) {
                    this.finalVelo = this.nowPosUnit.negative().multiply(this.veloRate);
                }
                this.nowPos = this.nowPos.add(this.finalVelo);
                this.op = util.map(this.nowPos.length(), sphereRad,  2*sphereRad, 1, 0);
            }


            else {
                this.finalPos = 0;
                this.finalVelo = 0;
                this.op = (this.life - this.age) / (this.life / 2);
                this.turnAngle = (this.turnAngle + turnSpeed) % (Math.PI * 2);
                var cosAngle = Math.cos(turnSpeed);
                var sinAngle = Math.sin(turnSpeed);
                this.x = cosAngle * this.nowPos.x + sinAngle * this.nowPos.z;
                this.z = -sinAngle * this.nowPos.x + cosAngle * this.nowPos.z;
                this.y = this.nowPos.y;
                this.nowPos = new Vector(this.x, this.y, this.z);
                this.age++;
            }
        }


        this.m = fLen / (fLen - this.nowPos.z);
        this.proj = {
            x: this.nowPos.x * this.m + centerX,
            y: this.nowPos.y * this.m + centerY,
            r: this.radius * this.m * 2
        }
    };


    var add = 0;
    function loop() {
        var p = null;
        context.clearRect(0, 0, width, height);
        var pl = particles.length;
        if (pl < maxParticle) {
            if (pl < 0.3 * maxParticle) {
                add++;

                if (add === 5) {
                    add = 0;
                    p = new Particle();
                    p.veloRate = 0.5;
                }
            }
            else if (pl < 0.7 * maxParticle) {
                p = new Particle();
                p.veloRate = 1 + Math.random() * 1;
            }
            else {
                p = new Particle();
                p.veloRate = 0.5 + Math.random() * 0.5;

            }
            if (p !== null) {
                processTime++;
                particles.push(p);
            }
        }

        for (var i = 0; i < particles.length; i++) {
            var p = particles[i];
            if (p.age === p.life) {
                particles.splice(i, 1);
                var p = new Particle();
                p.veloRate = 0.5 + Math.random() * 0.5;
                particles.push(p);
                processTime++;
            }

            p.update();

            if (p.m > 0) {
                if (p.color !== undefined) {
                    context.fillStyle = p.color + p.op + ")";
                    context.beginPath();
                    context.arc(p.proj.x, p.proj.y, p.proj.r, 0, Math.PI * 2);
                    context.fill();
                } else {
                    context.save();
                    context.globalAlpha = p.op;
                    context.drawImage(p.img, p.proj.x, p.proj.y, p.proj.r, p.proj.r);
                    context.restore();
                }


            }
        }
        requestAnimationFrame(loop);
    }

    var eventX, eventY;
    document.addEventListener("mousemove", function (e) {
        eventX = e.clientX;
        eventY = e.clientY;
        if (Math.abs(eventX - centerX) < sphereRad && Math.abs(eventY - centerY) < sphereRad) {
            for (var i = 0; i < particles.length; i++) {
                var p = particles[i];
                if (Math.abs(p.proj.x - eventX) < 20 && Math.abs(p.proj.y - eventY) < 20 && p.age > 0 && p.hover === false) {
                    p.hover = true;
                } else {
//                    p.hover = false;
                }
            }
        }
    });
    gui.add(this, "turnSpeed", 0.001, 0.01);
    gui.add(this, "greenDotSmallR", 0, 2);
    gui.add(this, "greenDotBigR", 0, 10);
    gui.add(this, "grayDotR", 0, 5);
    gui.add(this, "finalGreenPercent", 0, 1);
    gui.add(this, "greenDotBigPercent", 0, 1);
</script>
</body>
</html>
